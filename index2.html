<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>운동 따라하기 - Video Exercise Trainer</title>

    <!-- SEO Meta Tags -->
    <meta
      name="description"
      content="유튜브 영상을 보며 웹캠으로 자세를 확인하는 홈트레이닝 도우미. 나만의 운동 파트너."
    />
    <meta
      name="keywords"
      content="홈트, 운동, 다이어트, 유튜브, 웹캠, 거울모드, 피트니스, 헬스, AI 운동"
    />
    <meta name="author" content="Video Exercise Trainer" />

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Video Exercise Trainer" />
    <meta
      property="og:title"
      content="운동 따라하기 - Video Exercise Trainer"
    />
    <meta
      property="og:description"
      content="유튜브 운동 영상을 보면서 내 모습을 실시간으로 확인하세요. 완벽한 홈트레이닝을 위한 스플릿 스크린 솔루션."
    />
    <meta property="og:image" content="og_image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content="Video Exercise Trainer - Split screen workout interface"
    />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="운동 따라하기 - Video Exercise Trainer"
    />
    <meta
      name="twitter:description"
      content="유튜브와 웹캠을 동시에! 집에서 즐기는 전문적인 운동 경험."
    />
    <meta name="twitter:image" content="og_image.png" />

    <!-- Favicon -->
    <link rel="icon" href="favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="favicon.png" />

    <!-- Mobile App Meta Tags -->
    <meta name="theme-color" content="#0a0e27" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="운동 따라하기" />

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: #0a0e27;
        color: white;
        overflow: hidden;
      }

      .container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: #000;
        overflow: hidden;
      }

      .panel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
      }

      .video-panel {
        z-index: 1;
        display: flex;
        flex-direction: column;
      }

      /* Webcam Panel (Overlay) */
      .panel:last-child {
        z-index: 2;
        opacity: 0.5;
        pointer-events: none; /* Let clicks pass through to YouTube */
      }

      #player {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* Next Video Bar */
      .next-video-bar {
        background: rgba(20, 26, 58, 0.95);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .next-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        justify-content: flex-start;
        /* Left align text next to button */
        margin-left: 15px;
        overflow: hidden;
      }

      .next-label {
        color: #00d4ff;
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
      }

      .next-title {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Speed Controls Overlay (Desktop) */
      .speed-overlay {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 6px;
        background: rgba(0, 0, 0, 0.85);
        padding: 8px 12px;
        border-radius: 25px;
        z-index: 10;
      }

      /* Settings Menu (Mobile) */
      .settings-container {
        position: relative;
        margin-left: 10px;
        display: none;
        /* Hidden on desktop */
      }

      .speed-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        background: rgba(20, 26, 58, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        width: 200px;
        display: none;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
        margin-bottom: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      }

      .speed-menu.active {
        display: flex;
      }

      .speed-menu-title {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 5px;
        text-align: center;
      }

      .speed-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .speed-btn {
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        /* Default rounded */
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.8);
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      /* Desktop specific speed btn styles */
      .speed-overlay .speed-btn {
        width: 48px;
        height: 30px;
        border-radius: 15px;
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      /* Mobile menu specific speed btn styles */
      .speed-menu .speed-btn {
        width: 100%;
        height: 36px;
        border-radius: 8px;
      }

      .speed-btn:hover {
        border-color: #00d4ff;
        color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
      }

      .speed-btn.active {
        background: #00d4ff;
        border-color: #00d4ff;
        color: #000;
      }

      #webcam {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      .placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
      }

      /* Controls */
      .controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.9);
        padding: 15px 20px;
        border-radius: 15px;
        align-items: center;
        z-index: 100;
        white-space: nowrap;
      }

      button {
        background: #00d4ff;
        color: #000;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      button:hover {
        background: #00b8e6;
        transform: translateY(-1px);
      }

      button.active {
        background: #fff;
        color: #00d4ff;
      }

      .btn-icon {
        padding: 10px;
        border-radius: 50%;
      }

      /* Playlist Modal */
      .playlist-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(20, 26, 58, 0.98);
        padding: 30px;
        border-radius: 15px;
        width: 650px;
        max-height: 80vh;
        overflow-y: auto;
        display: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 200;
      }

      .playlist-modal.active {
        display: block;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close-btn {
        background: transparent;
        color: white;
        padding: 5px;
        width: 30px;
        height: 30px;
      }

      .playlist-item {
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        margin-bottom: 10px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .playlist-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .playlist-item.active {
        background: rgba(0, 212, 255, 0.2);
        border-left: 3px solid #00d4ff;
      }

      .item-info {
        flex: 1;
        cursor: pointer;
      }

      .item-actions {
        display: flex;
        gap: 8px;
      }

      .delete-btn {
        background: rgba(255, 0, 0, 0.3);
        color: #ff5555;
        padding: 8px 16px;
      }

      .add-form {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }

      input {
        width: 100%;
        padding: 12px;
        margin: 5px 0;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
        font-family: inherit;
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      /* Mobile Responsive Layout */
      @media (max-width: 768px) {
        .container {
          /* Maintain overlay layout on mobile */
        }

        /* Hide desktop speed overlay on mobile */
        .speed-overlay {
          display: none;
        }

        /* Show settings menu on mobile */
        .settings-container {
          display: block;
        }

        .controls {
          width: 98%;
          justify-content: center;
          padding: 8px 4px;
          bottom: 5px;
          gap: 4px;
          /* Ensure buttons fit */
        }

        button {
          padding: 6px;
          /* Smaller padding */
          font-size: 0;
          /* Hide text on mobile */
          min-width: 32px;
          /* Smaller min-width */
          justify-content: center;
        }

        button .material-symbols-outlined {
          font-size: 20px;
          /* Smaller icons */
          margin: 0;
        }

        .playlist-modal {
          width: 90%;
          max-height: 70vh;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- YouTube Panel -->
      <div class="panel video-panel">
        <div style="position: relative; flex: 1">
          <div id="player"></div>

          <!-- Speed Controls (Desktop Only) -->
          <div class="speed-overlay">
            <button class="speed-btn" data-speed="0.5">0.5x</button>
            <button class="speed-btn" data-speed="0.75">0.75x</button>
            <button class="speed-btn active" data-speed="1">1x</button>
            <button class="speed-btn" data-speed="1.25">1.25x</button>
            <button class="speed-btn" data-speed="1.5">1.5x</button>
            <button class="speed-btn" data-speed="2">2x</button>
          </div>
        </div>

        <!-- Next Video Bar -->
        <div class="next-video-bar">
          <button
            class="btn-icon"
            onclick="skipToNext()"
            title="다음 영상 바로가기"
          >
            <span class="material-symbols-outlined">skip_next</span>
          </button>
          <div class="next-info">
            <span class="next-label">다음:</span>
            <span class="next-title" id="nextTitle">-</span>
          </div>

          <!-- Settings Menu (Mobile Only) -->
          <div class="settings-container">
            <button
              class="btn-icon"
              onclick="toggleSpeedMenu()"
              title="재생 속도 설정"
            >
              <span class="material-symbols-outlined">settings</span>
            </button>
            <div class="speed-menu" id="speedMenu">
              <div class="speed-menu-title">재생 속도</div>
              <div class="speed-options">
                <button class="speed-btn" data-speed="0.5">0.5x</button>
                <button class="speed-btn" data-speed="0.75">0.75x</button>
                <button class="speed-btn active" data-speed="1">1x</button>
                <button class="speed-btn" data-speed="1.25">1.25x</button>
                <button class="speed-btn" data-speed="1.5">1.5x</button>
                <button class="speed-btn" data-speed="2">2x</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Webcam Panel -->
      <div class="panel">
        <video id="webcam" style="display: none" autoplay playsinline></video>
        <div class="placeholder" id="placeholder">웹캠 연결 중...</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button onclick="playPrevious()" title="이전 비디오">
        <span class="material-symbols-outlined">skip_previous</span>
      </button>
      <button onclick="seekBackward()" title="10초 뒤로">
        <span class="material-symbols-outlined">replay_10</span>
      </button>
      <button onclick="togglePlay()">
        <span class="material-symbols-outlined" id="playIcon">play_arrow</span>
      </button>
      <button onclick="seekForward()" title="10초 앞으로">
        <span class="material-symbols-outlined">forward_10</span>
      </button>
      <button onclick="playNext()" title="다음 비디오">
        <span class="material-symbols-outlined">skip_next</span>
      </button>
      <button onclick="togglePlaylist()">
        <span class="material-symbols-outlined">playlist_play</span>
      </button>
      <button onclick="toggleWebcam()" id="webcamBtn" title="웹캠 켜기/끄기">
        <span class="material-symbols-outlined">videocam</span>
      </button>
      <button onclick="toggleFlip()" id="flipBtn" title="좌우 반전">
        <span class="material-symbols-outlined">flip_camera_android</span>
      </button>
    </div>

    <!-- Playlist Modal -->
    <div class="playlist-modal" id="playlistModal">
      <div class="modal-header">
        <h2>플레이리스트 (<span id="count">0</span>)</h2>
        <button class="close-btn" onclick="togglePlaylist()">✕</button>
      </div>
      <div id="playlistItems"></div>
      <div class="add-form">
        <input type="text" id="urlInput" placeholder="YouTube URL 또는 ID" />
        <input type="text" id="titleInput" placeholder="제목" />
        <button onclick="addVideo()">
          <span class="material-symbols-outlined">add</span>
          추가
        </button>
      </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let playlist = [];
      let player;
      let webcamStream;
      let currentIndex = 0;
      let isFlipped = true; // Default to mirrored

      // Load playlist
      async function loadPlaylist() {
        // Always try to load from txt file first to reflect file changes
        try {
          const response = await fetch(
            "playlist.txt?t=" + new Date().getTime()
          ); // Prevent caching
          const text = await response.text();

          const filePlaylist = text
            .trim()
            .split("\n")
            .filter((line) => line.trim())
            .map((line) => {
              const [id, title] = line.split("|");
              return { id: id.trim(), title: title ? title.trim() : id.trim() };
            });

          if (filePlaylist.length > 0) {
            playlist = filePlaylist;
            console.log("Loaded from playlist.txt");
            // Update localStorage to match file
            savePlaylist();
          } else {
            throw new Error("Empty playlist file");
          }
        } catch (error) {
          console.log(
            "Failed to load playlist.txt, checking localStorage",
            error
          );

          // Fallback to localStorage
          const stored = localStorage.getItem("playlist");
          if (stored) {
            try {
              const parsed = JSON.parse(stored);
              if (Array.isArray(parsed) && parsed.length > 0) {
                playlist = parsed;
                console.log("Loaded from localStorage");
              }
            } catch (e) {
              console.error("Error parsing localStorage", e);
            }
          }

          // Final fallback
          if (playlist.length === 0) {
            playlist = [{ id: "372ByJedKsY", title: "기본 비디오" }];
          }
        }

        setStatus(`${playlist.length}개 비디오 로드됨`);
      }

      function savePlaylist() {
        localStorage.setItem("playlist", JSON.stringify(playlist));
        updatePlaylistUI();
        updateNextVideo();
      }

      function extractVideoId(input) {
        input = input.trim();
        if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;

        const patterns = [
          /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
          /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
        ];

        for (let p of patterns) {
          let match = input.match(p);
          if (match) return match[1];
        }
        return null;
      }

      function addVideo() {
        const url = document.getElementById("urlInput").value;
        const title =
          document.getElementById("titleInput").value || "새 비디오";

        const videoId = extractVideoId(url);
        if (!videoId) {
          alert("올바른 URL 또는 ID 입력");
          return;
        }

        playlist.push({ id: videoId, title: title });
        savePlaylist();

        document.getElementById("urlInput").value = "";
        document.getElementById("titleInput").value = "";
        setStatus(`"${title}" 추가됨`);
      }

      function deleteVideo(index) {
        if (playlist.length <= 1) {
          alert("최소 1개 필요");
          return;
        }

        if (confirm(`"${playlist[index].title}" 삭제?`)) {
          playlist.splice(index, 1);
          if (index <= currentIndex && currentIndex > 0) currentIndex--;
          savePlaylist();
          if (index === currentIndex) playVideo(currentIndex);
        }
      }

      function updatePlaylistUI() {
        const container = document.getElementById("playlistItems");
        const count = document.getElementById("count");

        container.innerHTML = "";
        count.textContent = playlist.length;

        playlist.forEach((v, i) => {
          const div = document.createElement("div");
          div.className =
            "playlist-item" + (i === currentIndex ? " active" : "");
          div.innerHTML = `
                    <div class="item-info" onclick="playVideo(${i})">
                        ${i + 1}. ${v.title}
                    </div>
                    <div class="item-actions">
                        <button class="delete-btn" onclick="deleteVideo(${i})">삭제</button>
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function updateNextVideo() {
        if (playlist.length === 0) return;
        const nextIndex = (currentIndex + 1) % playlist.length;
        document.getElementById("nextTitle").textContent =
          playlist[nextIndex].title;
      }

      function playVideo(index) {
        if (!player) return;
        currentIndex = index;
        player.loadVideoById(playlist[index].id);
        updatePlaylistUI();
        updateNextVideo();
        setStatus(`재생: ${playlist[index].title}`);
      }

      function playPrevious() {
        currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
        playVideo(currentIndex);
      }

      function playNext() {
        currentIndex = (currentIndex + 1) % playlist.length;
        playVideo(currentIndex);
      }

      function skipToNext() {
        playNext();
      }

      function togglePlay() {
        if (!player) return;
        if (player.getPlayerState() === 1) player.pauseVideo();
        else player.playVideo();
      }

      function seekBackward() {
        if (!player) return;
        const current = player.getCurrentTime();
        player.seekTo(Math.max(0, current - 10));
      }

      function seekForward() {
        if (!player) return;
        const current = player.getCurrentTime();
        const duration = player.getDuration();
        player.seekTo(Math.min(duration, current + 10));
      }

      function togglePlaylist() {
        document.getElementById("playlistModal").classList.toggle("active");
        // Close speed menu if open
        document.getElementById("speedMenu").classList.remove("active");
      }

      function toggleSpeedMenu() {
        document.getElementById("speedMenu").classList.toggle("active");
        // Close playlist if open
        document.getElementById("playlistModal").classList.remove("active");
      }

      // Close menus when clicking outside
      document.addEventListener("click", function (event) {
        const speedMenu = document.getElementById("speedMenu");
        const settingsBtn = event.target.closest(".settings-container");

        if (!settingsBtn && speedMenu.classList.contains("active")) {
          speedMenu.classList.remove("active");
        }
      });

      async function toggleWebcam() {
        const webcam = document.getElementById("webcam");
        const btn = document.getElementById("webcamBtn");
        const placeholder = document.getElementById("placeholder");

        if (webcamStream) {
          // Stop webcam
          webcamStream.getTracks().forEach((track) => track.stop());
          webcamStream = null;
          webcam.srcObject = null;
          webcam.style.display = "none";
          placeholder.style.display = "flex";
          placeholder.textContent = "웹캠이 꺼졌습니다";
          btn.classList.remove("active");
          setStatus("웹캠 꺼짐");
        } else {
          // Start webcam
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { width: 1280, height: 720 },
              audio: false,
            });

            webcam.srcObject = stream;
            webcam.style.display = "block";
            placeholder.style.display = "none";
            webcamStream = stream;
            btn.classList.add("active");
            setStatus("웹캠 켜짐");
          } catch (error) {
            alert("웹캠 권한 필요");
            placeholder.textContent = "웹캠 권한 필요";
          }
        }
      }

      function toggleFlip() {
        const webcam = document.getElementById("webcam");
        const btn = document.getElementById("flipBtn");
        isFlipped = !isFlipped;

        if (isFlipped) {
          webcam.style.transform = "scaleX(-1)";
          btn.classList.add("active");
          setStatus("좌우 반전 켜짐");
        } else {
          webcam.style.transform = "scaleX(1)";
          btn.classList.remove("active");
          setStatus("좌우 반전 꺼짐");
        }
      }

      function setStatus(text) {
        console.log(text);
      }

      // Speed controls
      document.querySelectorAll(".speed-btn").forEach((btn) => {
        btn.onclick = function () {
          if (!player) return;
          const speed = parseFloat(this.dataset.speed);
          player.setPlaybackRate(speed);
          document
            .querySelectorAll(".speed-btn")
            .forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          setStatus(`배속: ${speed}x`);
        };
      });

      function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
          height: "100%",
          width: "100%",
          videoId: playlist[0]?.id || "372ByJedKsY",
          playerVars: { autoplay: 1, controls: 1 },
          events: {
            onReady: (e) => {
              setStatus("준비 완료");
              e.target.playVideo();
              updatePlaylistUI();
              updateNextVideo();
            },
            onStateChange: (e) => {
              const icon = document.getElementById("playIcon");
              if (e.data === 1) {
                // Playing
                icon.textContent = "pause";
                errorCount = 0; // Reset error counter on successful play
              } else if (e.data === 2)
                icon.textContent = "play_arrow"; // Paused
              else if (e.data === 0) playNext(); // Ended
            },
            onError: onPlayerError,
          },
        });
      }

      let errorCount = 0;
      const MAX_ERRORS = 5;

      function onPlayerError(e) {
        console.error("YouTube Player Error:", e.data);
        let errorMessage = "재생 오류";

        switch (e.data) {
          case 2:
            errorMessage = "유효하지 않은 비디오 ID";
            break;
          case 5:
            errorMessage = "HTML5 플레이어 오류";
            break;
          case 100:
            errorMessage = "비디오를 찾을 수 없음 (삭제/비공개)";
            break;
          case 101:
          case 150:
            errorMessage = "임베드 허용되지 않음";
            break;
        }

        setStatus(`${errorMessage} (${e.data}) - 다음 영상으로 넘어갑니다.`);

        errorCount++;
        if (errorCount <= MAX_ERRORS) {
          setTimeout(() => {
            playNext();
          }, 1000); // Wait 1s before skipping to prevent rapid flickering
        } else {
          setStatus(
            "연속된 오류로 재생을 중단합니다. 플레이리스트를 확인해주세요."
          );
          errorCount = 0; // Reset for manual retry
        }
      }

      // Initialize
      loadPlaylist();
      toggleWebcam(); // Auto start webcam (using toggle function)
    </script>
  </body>
</html>
